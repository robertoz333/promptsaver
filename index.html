 <!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Saver con Bootstrap</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            background-color: #000;
            color: #fff;
            padding: 20px;
        }

        .category-box {
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .prompt-title-div.active {
            background-color: #28a745;
            color: #fff;
        }

        .prompt-content {
            background-color: #444;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .prompt-title-input,
        .prompt-tags-input {
            background-color: #fff;
            color: #000;
            border: 1px solid #555;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .prompt-title-input {
            padding: 10px;
            font-size: 18px;
        }

        .category-header {
            margin-bottom: 20px;
        }

        .prompt-titles-container {
            margin-bottom: 20px;
        }

        .btn-custom {
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            margin-top: 10px;
        }

        .btn-new {
            background-color: #28a745;
        }

        .btn-edit {
            background-color: #17a2b8;
        }

        .btn-save {
            background-color: #28a745;
            display: none;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-copy {
            background-color: #ffc107;
        }

        .btn-font {
            background-color: #ff9800;
        }

        .btn-share {
            background-color: #007bff;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-container .form-control {
            flex: 1;
        }

        .tag-badge {
            background-color: #ffc107;
            color: #000;
            border-radius: 3px;
            margin-right: 5px;
            padding: 5px;
        }

        /* Editor di Quill */
        #editor-container {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            height: 200px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        /* Imposta il colore del testo dell'editor in bianco */
        .ql-editor {
            background-color: #333;
            color: #fff;
        }

        /* Riduci l'interlinea tra i paragrafi */
        .ql-editor p {
            margin: 0;
        }

        /* Personalizza il selettore del caret (cursore del testo) */
        .ql-editor.ql-blank::before {
            color: #fff;
        }

        /* Stile per la toolbar di Quill */
        .ql-toolbar {
            background-color: #444;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px 5px 0 0;
        }

        .ql-toolbar .ql-stroke {
            stroke: #fff;
        }

        .ql-toolbar .ql-fill {
            fill: #fff;
        }

        .ql-toolbar .ql-picker {
            color: #fff;
        }

        .ql-toolbar .ql-picker-options {
            background-color: #444;
            color: #fff;
        }

        .ql-toolbar .ql-picker-item {
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center">Prompt Saver</h1>

        <!-- Barra di ricerca con filtri -->
        <div class="search-container">
            <input type="text" id="searchInput" class="form-control" placeholder="Cerca per parole chiave...">
            <select id="categoryFilter" class="form-control">
                <option value="">Tutte le categorie</option>
            </select>
            <input type="date" id="dateFilter" class="form-control">
            <input type="text" id="tagFilter" class="form-control" placeholder="Inserisci tag...">
            <button id="searchBtn" class="btn btn-success">üîç Cerca</button>
        </div>

        <div class="top-section mb-4">
            <div class="new-category-section w-100">
                <div class="input-group">
                    <input type="text" id="newCategoryInput" class="form-control" placeholder="Nuova categoria">
                    <div class="input-group-append">
                        <button id="addCategoryBtn" class="btn btn-success">Aggiungi Categoria</button>
                    </div>
                </div>
                <div id="categories" class="mt-3 d-flex flex-wrap"></div>
            </div>
        </div>

        <div id="prompts-display-container"></div>
        <div id="category-boxes-container"></div>
    </div>

    <!-- Modale per aggiungere/modificare un nuovo prompt -->
    <div class="modal fade" id="newPromptModal" tabindex="-1" role="dialog" aria-labelledby="newPromptModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="newPromptModalLabel">Nuovo Prompt</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newPromptForm">
                        <div class="form-group">
                            <label for="promptTitle">Titolo</label>
                            <input type="text" class="form-control" id="promptTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="promptTags">Tag (separati da virgole)</label>
                            <input type="text" class="form-control" id="promptTags"
                                placeholder="Inserisci i tag separati da virgole...">
                        </div>
                        <div class="form-group">
                            <label for="promptText">Testo</label>
                            <div id="editor-container"></div>
                        </div>
                        <button type="submit" class="btn btn-success">Aggiungi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Include jQuery, Popper.js, Bootstrap JS, and Quill -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script
        src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        var categories = [];
        var quill;
        var activeCategoryIndex = null;
        var activePromptIndex = null;

        function loadFromLocalStorage() {
            var savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
                renderCategories();
                populateCategoryFilter();
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        function renderCategories() {
            var container = document.getElementById('categories');
            var categoryBoxesContainer = document.getElementById('category-boxes-container');
            container.innerHTML = '';
            categoryBoxesContainer.innerHTML = '';

            categories.sort((a, b) => a.name.localeCompare(b.name));

            categories.forEach((category, index) => {
                const categoryDiv = document.createElement('button');
                categoryDiv.className = 'btn mr-2 mb-2';

                if (index === activeCategoryIndex) {
                    categoryDiv.classList.add('btn-success');
                } else {
                    categoryDiv.classList.add('btn-secondary');
                }

                categoryDiv.textContent = category.name;

                categoryDiv.onclick = () => {
                    toggleCategoryBox(categoryDiv, index);
                };

                container.appendChild(categoryDiv);

                const categoryBox = createCategoryBox(category, index);
                categoryBoxesContainer.appendChild(categoryBox);
            });
        }

        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Tutte le categorie</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }

        function searchPrompts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedCategory = document.getElementById('categoryFilter').value;
            const selectedDate = document.getElementById('dateFilter').value;
            const selectedTag = document.getElementById('tagFilter').value.toLowerCase().trim();

            const promptsDisplayContainer = document.getElementById('prompts-display-container');
            promptsDisplayContainer.innerHTML = '<h2>Risultati della ricerca</h2>';

            let resultsFound = false;

            categories.forEach((category, categoryIndex) => {
                if (selectedCategory && category.name !== selectedCategory) return;

                const filteredPrompts = category.prompts.filter(prompt => {
                    const matchTitleOrText = prompt.title.toLowerCase().includes(searchQuery) || prompt.text.toLowerCase().includes(searchQuery);
                    const matchDate = !selectedDate || prompt.date === selectedDate;
                    const matchTag = !selectedTag || (prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(selectedTag)));

                    return matchTitleOrText && matchDate && matchTag;
                });

                if (filteredPrompts.length > 0) {
                    resultsFound = true;

                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category.name;
                    promptsDisplayContainer.appendChild(categoryHeader);

                    const promptGrid = document.createElement('div');
                    promptGrid.className = 'prompt-grid';

                    filteredPrompts.forEach((prompt, promptIndex) => {
                        const { promptDiv } = createPromptDiv(prompt, categoryIndex, promptIndex);
                        promptGrid.appendChild(promptDiv);
                    });

                    promptsDisplayContainer.appendChild(promptGrid);
                }
            });

            if (!resultsFound) {
                promptsDisplayContainer.innerHTML += '<p>Nessun risultato trovato.</p>';
            }
        }

        function createCategoryBox(category, categoryIndex) {
            const categoryBox = document.createElement('div');
            categoryBox.className = 'category-box';
            categoryBox.style.display = (categoryIndex === activeCategoryIndex) ? 'block' : 'none';

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header d-flex align-items-center';

            const categoryInput = document.createElement('input');
            categoryInput.type = 'text';
            categoryInput.value = category.name;
            categoryInput.className = 'form-control mr-2';
            categoryInput.readOnly = true;
            categoryHeader.appendChild(categoryInput);

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-info btn-edit btn-custom';
            editBtn.textContent = 'Modifica';
            categoryHeader.appendChild(editBtn);

            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-save btn-custom';
            saveBtn.textContent = 'Salva';
            categoryHeader.appendChild(saveBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-delete btn-custom';
            deleteBtn.textContent = 'Elimina';
            categoryHeader.appendChild(deleteBtn);

            categoryBox.appendChild(categoryHeader);

            editBtn.onclick = () => {
                categoryInput.readOnly = false;
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline';
            };

            saveBtn.onclick = () => {
                categoryInput.readOnly = true;
                editBtn.style.display = 'inline';
                saveBtn.style.display = 'none';
                categories[categoryIndex].name = categoryInput.value;
                saveToLocalStorage();
                renderCategories();
            };

            deleteBtn.onclick = () => {
                deleteCategory(categoryIndex);
            };

            const promptTitlesContainer = document.createElement('div');
            promptTitlesContainer.className = 'prompt-titles-container d-flex flex-wrap';

            const selectedPromptContainer = document.createElement('div');
            selectedPromptContainer.className = 'selected-prompt-container';

            category.prompts.sort((a, b) => a.title.localeCompare(b.title));

            category.prompts.forEach((prompt, promptIndex) => {
                const promptTitleDiv = createPromptTitleDiv(prompt, categoryIndex, promptIndex, selectedPromptContainer);
                promptTitlesContainer.appendChild(promptTitleDiv);

                // Se √® il prompt attivo, visualizzalo aperto
                if (categoryIndex === activeCategoryIndex && promptIndex === activePromptIndex) {
                    displaySelectedPrompt(prompt, categoryIndex, promptIndex, selectedPromptContainer);
                }
            });

            categoryBox.appendChild(promptTitlesContainer);
            categoryBox.appendChild(selectedPromptContainer);

            const newPromptBtn = document.createElement('button');
            newPromptBtn.className = 'btn btn-success btn-new mt-3';
            newPromptBtn.textContent = 'Nuovo Prompt';
            newPromptBtn.onclick = () => {
                showNewPromptForm(categoryIndex);
            };
            categoryBox.appendChild(newPromptBtn);

            return categoryBox;
        }

        function createPromptTitleDiv(prompt, categoryIndex, promptIndex, selectedPromptContainer) {
            const promptTitleDiv = document.createElement('button');
            promptTitleDiv.className = 'btn btn-secondary mr-2 mb-2';
            promptTitleDiv.textContent = prompt.title;

            promptTitleDiv.onclick = () => {
                activeCategoryIndex = categoryIndex;
                activePromptIndex = promptIndex;
                displaySelectedPrompt(prompt, categoryIndex, promptIndex, selectedPromptContainer);
            };

            return promptTitleDiv;
        }

        function createPromptDiv(prompt, categoryIndex, promptIndex) {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'prompt-content';

            const title = document.createElement('h4');
            title.textContent = prompt.title;
            promptDiv.appendChild(title);

            const tagsDiv = document.createElement('div');
            if (prompt.tags) {
                prompt.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag-badge';
                    tagSpan.textContent = tag;
                    tagsDiv.appendChild(tagSpan);
                });
            }
            promptDiv.appendChild(tagsDiv);

            const content = document.createElement('div');
            content.innerHTML = prompt.text;
            promptDiv.appendChild(content);

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'mt-3';

            // Ordine dei bottoni: Modifica, Copia, Elimina, Aumenta il font, Condividi
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-info btn-edit btn-custom';
            editBtn.textContent = 'Modifica';
            buttonsDiv.appendChild(editBtn);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-warning btn-copy btn-custom';
            copyBtn.textContent = 'Copia';
            buttonsDiv.appendChild(copyBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-delete btn-custom';
            deleteBtn.textContent = 'Elimina';
            buttonsDiv.appendChild(deleteBtn);

            const fontBtn = document.createElement('button');
            fontBtn.className = 'btn btn-orange btn-font btn-custom';
            fontBtn.textContent = 'Aumenta Font';
            buttonsDiv.appendChild(fontBtn);

            const shareBtn = document.createElement('button');
            shareBtn.className = 'btn btn-share btn-custom';
            shareBtn.textContent = 'Condividi';
            buttonsDiv.appendChild(shareBtn);

            promptDiv.appendChild(buttonsDiv);

            copyBtn.onclick = () => {
                var plainText = htmlToPlainText(prompt.text);
                navigator.clipboard.writeText(plainText).then(() => {
                    alert('Prompt copiato negli appunti!');
                }).catch(err => {
                    console.error('Errore nella copia del testo: ', err);
                });
            };

            fontBtn.onclick = () => {
                content.style.fontSize = 'larger';
            };

            editBtn.onclick = () => {
                showEditPromptForm(prompt, categoryIndex, promptIndex);
            };

            deleteBtn.onclick = () => {
                if (confirm('Sei sicuro di voler eliminare questo prompt?')) {
                    categories[categoryIndex].prompts.splice(promptIndex, 1);
                    saveToLocalStorage();
                    renderCategories();
                }
            };

            shareBtn.onclick = () => {
                sharePrompt(prompt);
            };

            return { promptDiv };
        }

        function htmlToPlainText(html) {
            var tempElement = document.createElement('div');
            tempElement.innerHTML = html;

            // Rimuovi script e stili
            var scripts = tempElement.getElementsByTagName('script');
            for (var i = scripts.length - 1; i >= 0; i--) {
                scripts[i].parentNode.removeChild(scripts[i]);
            }
            var styles = tempElement.getElementsByTagName('style');
            for (var i = styles.length - 1; i >= 0; i--) {
                styles[i].parentNode.removeChild(styles[i]);
            }

            // Gestisci <br> come newline
            tempElement.innerHTML = tempElement.innerHTML.replace(/<br\s*[\/]?>/gi, '\n');

            // Gestisci elenchi ordinati
            var olElements = tempElement.getElementsByTagName('ol');
            for (var i = 0; i < olElements.length; i++) {
                var ol = olElements[i];
                var items = ol.getElementsByTagName('li');
                for (var j = 0; j < items.length; j++) {
                    items[j].innerText = (j + 1) + '. ' + items[j].innerText;
                }
                ol.outerHTML = ol.innerHTML;
            }

            // Gestisci elenchi non ordinati
            var ulElements = tempElement.getElementsByTagName('ul');
            for (var i = 0; i < ulElements.length; i++) {
                var ul = ulElements[i];
                var items = ul.getElementsByTagName('li');
                for (var j = 0; j < items.length; j++) {
                    items[j].innerText = '- ' + items[j].innerText;
                }
                ul.outerHTML = ul.innerHTML;
            }

            // Ottieni il testo
            var text = tempElement.textContent || tempElement.innerText || '';

            // Rimuovi spazi e newline multipli
            text = text.replace(/\n\s*\n/g, '\n').trim();

            return text;
        }

        function displaySelectedPrompt(prompt, categoryIndex, promptIndex, container) {
            container.innerHTML = '';
            const { promptDiv } = createPromptDiv(prompt, categoryIndex, promptIndex);
            container.appendChild(promptDiv);
        }

        function toggleCategoryBox(categoryDiv, categoryIndex) {
            const categoryBoxes = document.querySelectorAll('.category-box');
            const categoryDivs = document.querySelectorAll('#categories .btn');
            categoryBoxes.forEach((box, idx) => {
                if (idx === categoryIndex) {
                    const isVisible = box.style.display === 'block';
                    box.style.display = isVisible ? 'none' : 'block';
                    if (isVisible) {
                        categoryDivs[idx].classList.remove('btn-success');
                        categoryDivs[idx].classList.add('btn-secondary');
                    } else {
                        categoryDivs[idx].classList.remove('btn-secondary');
                        categoryDivs[idx].classList.add('btn-success');
                    }
                } else {
                    box.style.display = 'none';
                    categoryDivs[idx].classList.remove('btn-success');
                    categoryDivs[idx].classList.add('btn-secondary');
                }
            });
        }

        function showNewPromptForm(categoryIndex) {
            $('#newPromptModal').modal('show');
            $('#newPromptModalLabel').text('Nuovo Prompt');

            // Non pulire i campi per mantenere il titolo e il testo dopo l'aggiunta
            // $('#promptTitle').val('');
            // $('#promptTags').val('');
            // quill.root.innerHTML = '';

            $('#newPromptForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const title = $('#promptTitle').val();
                const text = quill.root.innerHTML;
                const tags = $('#promptTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

                if (title && text) {
                    categories[categoryIndex].prompts.push({ title, text, tags });
                    saveToLocalStorage();

                    // Imposta gli indici attivi per visualizzare il nuovo prompt
                    activeCategoryIndex = categoryIndex;
                    activePromptIndex = categories[categoryIndex].prompts.length - 1;

                    renderCategories();
                    // Mantiene aperta la modale e non pulisce i campi per vedere titolo e testo
                }
            });
        }

        function showEditPromptForm(prompt, categoryIndex, promptIndex) {
            $('#newPromptModal').modal('show');
            $('#newPromptModalLabel').text('Modifica Prompt');
            $('#promptTitle').val(prompt.title);
            $('#promptTags').val(prompt.tags ? prompt.tags.join(', ') : '');
            quill.root.innerHTML = prompt.text;

            $('#newPromptForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const title = $('#promptTitle').val();
                const text = quill.root.innerHTML;
                const tags = $('#promptTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

                if (title && text) {
                    categories[categoryIndex].prompts[promptIndex] = { title, text, tags };
                    saveToLocalStorage();

                    // Imposta gli indici attivi per visualizzare il prompt modificato
                    activeCategoryIndex = categoryIndex;
                    activePromptIndex = promptIndex;
                    $('#newPromptModal').modal('hide');
                    renderCategories();
                }
            });
        }

        function deleteCategory(categoryIndex) {
            if (confirm('Sei sicuro di voler eliminare questa categoria?')) {
                categories.splice(categoryIndex, 1);
                saveToLocalStorage();
                renderCategories();
            }
        }

        function sharePrompt(prompt) {
            var plainText = htmlToPlainText(prompt.text);
            var shareData = {
                title: prompt.title,
                text: plainText,
            };

            if (navigator.share) {
                navigator.share(shareData).then(() => {
                    console.log('Prompt condiviso con successo!');
                }).catch(err => {
                    console.error('Errore nella condivisione del prompt: ', err);
                });
            } else {
                // Se l'API Web Share non √® supportata, copia il testo negli appunti
                navigator.clipboard.writeText(plainText).then(() => {
                    alert('Prompt copiato negli appunti! Puoi incollarlo per condividerlo.');
                }).catch(err => {
                    console.error('Errore nella copia del testo: ', err);
                });
            }
        }

        document.getElementById('addCategoryBtn').onclick = function () {
            const categoryName = document.getElementById('newCategoryInput').value;
            if (categoryName) {
                categories.push({ name: categoryName, prompts: [] });
                saveToLocalStorage();
                renderCategories();
                document.getElementById('newCategoryInput').value = '';
            }
        };

        document.getElementById('searchBtn').onclick = searchPrompts;

        document.getElementById('searchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                searchPrompts();
            }
        });

        // Inizializza Quill
        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'Scrivi qui il testo del prompt...',
            modules: {
                toolbar: [
                    [{ header: [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    ['link', 'blockquote', 'code-block'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['clean']
                ]
            }
        });

        loadFromLocalStorage();
    </script>
</body>

</html>
