<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Saver con Bootstrap</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* ... (stili esistenti) ... */
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center">Prompt Saver</h1>

        <div class="search-container mb-4">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Cerca prompt, categoria o parole chiave...">
                <div class="input-group-append">
                    <button id="searchBtn" class="btn btn-success">üîç</button>
                </div>
            </div>
            <div class="mt-2">
                <input type="date" id="dateFilter" class="form-control d-inline-block w-auto mr-2">
                <select id="categoryFilter" class="form-control d-inline-block w-auto mr-2">
                    <option value="">Tutte le categorie</option>
                </select>
                <input type="text" id="tagFilter" class="form-control d-inline-block w-auto" placeholder="Tag">
            </div>
        </div>

        <!-- ... (resto del codice HTML esistente) ... -->
    </div>

    <!-- Modale per aggiungere un nuovo prompt -->
    <div class="modal fade" id="newPromptModal" tabindex="-1" role="dialog" aria-labelledby="newPromptModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="newPromptModalLabel">Nuovo Prompt</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="newPromptForm">
              <div class="form-group">
                <label for="promptTitle">Titolo</label>
                <input type="text" class="form-control" id="promptTitle" required>
              </div>
              <div class="form-group">
                <label for="promptText">Testo</label>
                <textarea class="form-control" id="promptText" rows="5" required></textarea>
              </div>
              <div class="form-group">
                <label for="promptTags">Tag (separati da virgola)</label>
                <input type="text" class="form-control" id="promptTags">
              </div>
              <button type="submit" class="btn btn-success">Aggiungi</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Include jQuery, Popper.js, and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        var categories = [];

        function loadFromLocalStorage() {
            var savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
                renderCategories();
                updateCategoryFilter();
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        function renderCategories() {
            // ... (codice esistente) ...
        }

        function createCategoryBox(category, categoryIndex) {
            // ... (codice esistente) ...
        }

        function createPromptTitleDiv(prompt, categoryIndex, promptIndex) {
            // ... (codice esistente) ...
        }

        function autoResizeTextArea(element) {
            // ... (codice esistente) ...
        }

        function displaySelectedPrompt(promptTitleDiv, prompt, categoryIndex, promptIndex) {
            // ... (codice esistente) ...
        }

        function createPromptDiv(prompt, categoryIndex, promptIndex) {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'prompt-content';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'prompt-title-input form-control';
            titleInput.value = prompt.title;
            titleInput.readOnly = true;

            promptDiv.appendChild(titleInput);

            const textArea = document.createElement('textarea');
            textArea.className = 'prompt-text form-control';
            textArea.value = prompt.text;
            textArea.readOnly = true;

            promptDiv.appendChild(textArea);

            const tagsInput = document.createElement('input');
            tagsInput.type = 'text';
            tagsInput.className = 'prompt-tags-input form-control mt-2';
            tagsInput.value = prompt.tags ? prompt.tags.join(', ') : '';
            tagsInput.readOnly = true;
            tagsInput.placeholder = 'Tag';

            promptDiv.appendChild(tagsInput);

            const dateSpan = document.createElement('span');
            dateSpan.className = 'prompt-date mt-2 d-block';
            dateSpan.textContent = `Creato il: ${new Date(prompt.date).toLocaleDateString()}`;

            promptDiv.appendChild(dateSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'prompt-actions mt-3';

            // ... (resto del codice per i pulsanti) ...

            editBtn.onclick = (e) => {
                e.stopPropagation();
                titleInput.readOnly = false;
                textArea.readOnly = false;
                tagsInput.readOnly = false;
                titleInput.focus();
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline';
            };

            saveBtn.onclick = (e) => {
                e.stopPropagation();
                titleInput.readOnly = true;
                textArea.readOnly = true;
                tagsInput.readOnly = true;
                editBtn.style.display = 'inline';
                saveBtn.style.display = 'none';

                categories[categoryIndex].prompts[promptIndex].title = titleInput.value;
                categories[categoryIndex].prompts[promptIndex].text = textArea.value;
                categories[categoryIndex].prompts[promptIndex].tags = tagsInput.value.split(',').map(tag => tag.trim());
                saveToLocalStorage();

                // Aggiorna il titolo nel promptTitleDiv
                const promptTitlesContainer = promptDiv.closest('.category-box').querySelector('.prompt-titles-container');
                const promptTitleDivs = promptTitlesContainer.querySelectorAll('.btn');
                promptTitleDivs[promptIndex].textContent = titleInput.value;
            };

            // ... (resto del codice per i pulsanti) ...

            return { promptDiv, textArea, titleInput, tagsInput };
        }

        function toggleCategoryBox(categoryDiv, categoryIndex) {
            // ... (codice esistente) ...
        }

        function showNewPromptForm(categoryIndex) {
            $('#newPromptModal').modal('show');

            $('#newPromptForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const title = $('#promptTitle').val();
                const text = $('#promptText').val();
                const tags = $('#promptTags').val().split(',').map(tag => tag.trim());
                if (title && text) {
                    categories[categoryIndex].prompts.push({ 
                        title, 
                        text, 
                        tags,
                        date: new Date().toISOString()
                    });
                    saveToLocalStorage();
                    renderCategories();
                    $('#newPromptModal').modal('hide');
                    $('#promptTitle').val('');
                    $('#promptText').val('');
                    $('#promptTags').val('');
                }
            });
        }

        function deleteCategory(categoryIndex) {
            // ... (codice esistente) ...
        }

        function searchPrompts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const dateFilter = document.getElementById('dateFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const tagFilter = document.getElementById('tagFilter').value.toLowerCase().trim();
            const promptsDisplayContainer = document.getElementById('prompts-display-container');
            promptsDisplayContainer.innerHTML = '<h2>Risultati della ricerca</h2>';

            let resultsFound = false;

            categories.forEach((category, categoryIndex) => {
                if (categoryFilter && category.name !== categoryFilter) {
                    return;
                }

                category.prompts.forEach((prompt, promptIndex) => {
                    if (dateFilter && new Date(prompt.date).toISOString().split('T')[0] !== dateFilter) {
                        return;
                    }

                    if (tagFilter && (!prompt.tags || !prompt.tags.some(tag => tag.toLowerCase().includes(tagFilter)))) {
                        return;
                    }

                    if (
                        prompt.title.toLowerCase().includes(searchQuery) ||
                        prompt.text.toLowerCase().includes(searchQuery) ||
                        category.name.toLowerCase().includes(searchQuery) ||
                        (prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                    ) {
                        resultsFound = true;
                        const { promptDiv } = createPromptDiv(prompt, categoryIndex, promptIndex);
                        promptDiv.insertAdjacentHTML('afterbegin', `<h3>${category.name}</h3>`);
                        promptsDisplayContainer.appendChild(promptDiv);
                    }
                });
            });

            if (!resultsFound) {
                promptsDisplayContainer.innerHTML += '<p>Nessun risultato trovato.</p>';
            }
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Tutte le categorie</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }

        document.getElementById('addCategoryBtn').onclick = function () {
            const categoryName = document.getElementById('newCategoryInput').value;
            if (categoryName) {
                categories.push({ name: categoryName, prompts: [] });
                saveToLocalStorage();
                renderCategories();
                updateCategoryFilter();
                document.getElementById('newCategoryInput').value = '';
            }
        };

        document.getElementById('searchBtn').onclick = searchPrompts;

        document.getElementById('searchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                searchPrompts();
            }
        });

        document.getElementById('dateFilter').addEventListener('change', searchPrompts);
        document.getElementById('categoryFilter').addEventListener('change', searchPrompts);
        document.getElementById('tagFilter').addEventListener('input', searchPrompts);

        loadFromLocalStorage();
    </script>
</body>

</html>
