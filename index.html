<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Prompt Saver con Bootstrap</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Include SortableJS CSS (opzionale, per alcuni stili) -->
    <style>
        :root {
            --background-color: #000;
            --text-color: #fff;
            --category-box-background-color: #333;
            --prompt-content-background-color: #444;
            --prompt-title-input-background-color: #fff;
            --prompt-title-input-text-color: #000;
            --ql-editor-background-color: #333;
            --ql-editor-text-color: #fff;
            --ql-toolbar-background-color: #444;
            --ql-toolbar-icon-color: #fff;
            --tag-badge-background-color: #ffc107;
            --tag-badge-text-color: #000;
        }

        /* Tema chiaro */
        .light-theme {
            --background-color: #fff;
            --text-color: #000;
            --category-box-background-color: #f8f9fa;
            --prompt-content-background-color: #e9ecef;
            --prompt-title-input-background-color: #fff;
            --prompt-title-input-text-color: #000;
            --ql-editor-background-color: #fff;
            --ql-editor-text-color: #000;
            --ql-toolbar-background-color: #e9ecef;
            --ql-toolbar-icon-color: #000;
            --tag-badge-background-color: #ffc107;
            --tag-badge-text-color: #000;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px;
        }

        .category-box {
            background-color: var(--category-box-background-color);
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .prompt-title-div.active {
            background-color: #28a745;
            color: #fff;
        }

        .prompt-content {
            background-color: var(--prompt-content-background-color);
            color: var(--text-color);
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .prompt-title-input,
        .prompt-tags-input {
            background-color: var(--prompt-title-input-background-color);
            color: var(--prompt-title-input-text-color);
            border: 1px solid #555;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .prompt-title-input {
            padding: 10px;
            font-size: 18px;
        }

        .category-header {
            margin-bottom: 20px;
        }

        .prompt-titles-container {
            margin-bottom: 20px;
        }

        .btn-custom {
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            margin-top: 10px;
        }

        .btn-new {
            background-color: #28a745;
        }

        .btn-edit {
            background-color: #17a2b8;
        }

        .btn-save {
            background-color: #28a745;
            display: none;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-copy {
            background-color: #ffc107;
            color: #000;
        }

        .btn-font {
            background-color: #ff9800;
        }

        .btn-share {
            background-color: #007bff;
        }

        .btn-favorite {
            background-color: #ff69b4;
        }

        .btn-remove-favorite {
            background-color: #6c757d;
        }

        .btn-feedback {
            background-color: #ff5722;
            color: #fff;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-container .form-control {
            flex: 1;
            min-width: 200px;
        }

        .tag-badge {
            background-color: var(--tag-badge-background-color);
            color: var(--tag-badge-text-color);
            border-radius: 3px;
            margin-right: 5px;
            padding: 5px;
        }

        /* Editor di Quill */
        #editor-container {
            background-color: var(--ql-editor-background-color);
            color: var(--ql-editor-text-color);
            border: 1px solid #555;
            height: 200px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .ql-editor {
            background-color: var(--ql-editor-background-color);
            color: var(--ql-editor-text-color);
        }

        .ql-editor p {
            margin: 0;
        }

        .ql-editor.ql-blank::before {
            color: var(--ql-editor-text-color);
        }

        .ql-toolbar {
            background-color: var(--ql-toolbar-background-color);
            color: var(--ql-toolbar-icon-color);
            border: 1px solid #555;
            border-radius: 5px 5px 0 0;
        }

        .ql-toolbar .ql-stroke {
            stroke: var(--ql-toolbar-icon-color);
        }

        .ql-toolbar .ql-fill {
            fill: var(--ql-toolbar-icon-color);
        }

        .ql-toolbar .ql-picker {
            color: var(--ql-toolbar-icon-color);
        }

        .ql-toolbar .ql-picker-options {
            background-color: var(--ql-toolbar-background-color);
            color: var(--ql-toolbar-icon-color);
        }

        .ql-toolbar .ql-picker-item {
            color: var(--ql-toolbar-icon-color);
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .btn-custom {
                margin-right: 0;
                width: 100%;
            }
        }

        /* Stili per il drag-and-drop */
        .sortable-ghost {
            opacity: 0.5;
        }

        .sortable-chosen {
            background-color: #6c757d !important;
        }

        .color-indicator {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }

        /* Stili per l'input color */
        input[type="color"].form-control {
            padding: 0;
            height: auto;
        }

        /* Allinea gli elementi nella categoria */
        .category-header .form-control {
            max-width: 200px;
        }

        .category-header .btn-custom {
            margin-left: 5px;
        }

        /* Classe personalizzata per i pulsanti delle categorie */
        .category-btn {
            display: flex;
            align-items: center;
            margin-right: 5px;
            margin-bottom: 5px;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
        }

    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center" data-i18n="prompt_saver">Prompt Saver</h1>

        <!-- Selettore di lingua e tema -->
        <div class="d-flex justify-content-between mb-3">
            <div class="language-selector">
                <label for="languageSelect" data-i18n="select_language">Seleziona Lingua:</label>
                <select id="languageSelect" class="form-control" style="width: auto; display: inline-block;">
                    <option value="it" data-i18n="italian">Italiano</option>
                    <option value="en" data-i18n="english">English</option>
                    <!-- Aggiungi altre lingue qui -->
                </select>
            </div>
            <div class="theme-selector">
                <label for="themeSelect" data-i18n="select_theme">Seleziona Tema:</label>
                <select id="themeSelect" class="form-control" style="width: auto; display: inline-block;">
                    <option value="dark" data-i18n="dark_theme">Scuro</option>
                    <option value="light" data-i18n="light_theme">Chiaro</option>
                </select>
            </div>
        </div>

        <!-- Barra di ricerca con filtri -->
        <div class="search-container">
            <input type="text" id="searchInput" class="form-control" data-i18n-placeholder="search_placeholder">
            <select id="categoryFilter" class="form-control">
                <option value="" data-i18n="all_categories">Tutte le categorie</option>
            </select>
            <input type="date" id="dateFilter" class="form-control">
            <input type="text" id="tagFilter" class="form-control" data-i18n-placeholder="enter_tags">
            <button id="searchBtn" class="btn btn-success" data-i18n="search_button">üîç Cerca</button>
        </div>

        <!-- Bottoni di backup e ripristino -->
        <div class="backup-buttons">
            <button id="restoreBackupBtn" class="btn btn-warning" data-i18n="restore_backup">Ripristina Backup</button>
            <button id="exportDataBtn" class="btn btn-info" data-i18n="export_data">Esporta Dati</button>
            <button id="importDataBtn" class="btn btn-secondary" data-i18n="import_data">Importa Dati</button>
            <button id="feedbackBtn" class="btn btn-feedback" data-i18n="feedback_button">Feedback</button>
        </div>

        <div class="top-section mb-4">
            <div class="new-category-section w-100">
                <div class="input-group">
                    <input type="text" id="newCategoryInput" class="form-control" data-i18n-placeholder="new_category">
                    <input type="color" id="newCategoryColor" class="form-control" style="max-width: 50px; padding: 0;"
                        value="#6c757d">
                    <div class="input-group-append">
                        <button id="addCategoryBtn" class="btn btn-success" data-i18n="add_category">Aggiungi
                            Categoria</button>
                    </div>
                </div>
                <div id="categories" class="mt-3 d-flex flex-wrap"></div>
            </div>
            <div class="favorites-section w-100 mt-3">
                <button id="showFavoritesBtn" class="btn btn-warning" data-i18n="show_favorites">Mostra Preferiti</button>
                <button id="hideFavoritesBtn" class="btn btn-danger" style="display: none;"
                    data-i18n="hide_favorites">Chiudi Preferiti</button>
            </div>
        </div>

        <div id="prompts-display-container"></div>
        <div id="category-boxes-container"></div>
    </div>

    <!-- Modale per aggiungere/modificare un nuovo prompt -->
    <div class="modal fade" id="newPromptModal" tabindex="-1" role="dialog" aria-labelledby="newPromptModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="newPromptModalLabel" data-i18n="new_prompt">Nuovo Prompt</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newPromptForm">
                        <div class="form-group">
                            <label for="promptTitle" data-i18n="title_label">Titolo</label>
                            <input type="text" class="form-control" id="promptTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="promptTags" data-i18n="tags_label">Tag (separati da virgole)</label>
                            <input type="text" class="form-control" id="promptTags"
                                data-i18n-placeholder="tags_placeholder">
                        </div>
                        <div class="form-group">
                            <label for="promptText" data-i18n="text_label">Testo</label>
                            <div id="editor-container"></div>
                        </div>
                        <button type="submit" class="btn btn-success" data-i18n="add_button">Aggiungi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale per il feedback -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog" aria-labelledby="feedbackModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel" data-i18n="feedback_title">Feedback</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label for="feedbackText" data-i18n="feedback_label">Il tuo feedback:</label>
                            <textarea class="form-control" id="feedbackText" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success" data-i18n="send_feedback_button">Invia Feedback</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Include jQuery, Popper.js, Bootstrap JS, Quill, and SortableJS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script
        src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Include SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <script>
        var categories = [];
        var feedbacks = [];
        var quill;
        var activeCategoryIndex = null;
        var activePromptIndex = null;
        var currentLanguage = 'it';
        var currentTheme = 'dark';

        var translations = {
            'it': {
                'title': 'Prompt Saver con Bootstrap',
                'prompt_saver': 'Prompt Saver',
                'select_language': 'Seleziona Lingua:',
                'select_theme': 'Seleziona Tema:',
                'dark_theme': 'Scuro',
                'light_theme': 'Chiaro',
                'italian': 'Italiano',
                'english': 'Inglese',
                'search_placeholder': 'Cerca per parole chiave...',
                'all_categories': 'Tutte le categorie',
                'enter_tags': 'Inserisci tag...',
                'search_button': 'üîç Cerca',
                'restore_backup': 'Ripristina Backup',
                'export_data': 'Esporta Dati',
                'import_data': 'Importa Dati',
                'new_category': 'Nuova categoria',
                'add_category': 'Aggiungi Categoria',
                'show_favorites': 'Mostra Preferiti',
                'hide_favorites': 'Chiudi Preferiti',
                'new_prompt': 'Nuovo Prompt',
                'title_label': 'Titolo',
                'tags_label': 'Tag (separati da virgole)',
                'tags_placeholder': 'Inserisci i tag separati da virgole...',
                'text_label': 'Testo',
                'add_button': 'Aggiungi',
                'modify_button': 'Modifica',
                'save_button': 'Salva',
                'delete_button': 'Elimina',
                'copy_button': 'Copia',
                'increase_font_button': 'Aumenta Font',
                'share_button': 'Condividi',
                'favorite_button': '‚òÖ Preferito',
                'not_favorite_button': '‚òÜ Preferito',
                'remove_favorite_button': 'Elimina dai Preferiti',
                'search_results': 'Risultati della ricerca',
                'no_results_found': 'Nessun risultato trovato.',
                'favorites_title': 'Prompts Preferiti',
                'no_favorites_found': 'Nessun prompt preferito trovato.',
                'confirm_delete_prompt': 'Sei sicuro di voler eliminare questo prompt?',
                'confirm_delete_category': 'Sei sicuro di voler eliminare questa categoria?',
                'confirm_restore_backup': 'Sei sicuro di voler ripristinare il backup? Tutte le modifiche recenti andranno perse.',
                'backup_restored': 'Backup ripristinato con successo.',
                'no_backup_available': 'Nessun backup disponibile.',
                'data_imported': 'Dati importati con successo.',
                'invalid_file_format': 'Formato del file non valido.',
                'import_error': 'Errore nell\'importazione dei dati: ',
                'prompt_copied': 'Prompt copiato negli appunti!',
                'prompt_shared': 'Prompt condiviso con successo!',
                'share_error': 'Errore nella condivisione del prompt: ',
                'copy_error': 'Errore nella copia del testo: ',
                'copy_count_label': 'Copiato: ',
                'edit_count_label': 'Modificato: ',
                'modify_color': 'Modifica colore:',
                'feedback_button': 'Feedback',
                'feedback_title': 'Feedback',
                'feedback_label': 'Il tuo feedback:',
                'send_feedback_button': 'Invia Feedback',
                'feedback_thanks': 'Grazie per il tuo feedback!',
            },
            'en': {
                'title': 'Prompt Saver with Bootstrap',
                'prompt_saver': 'Prompt Saver',
                'select_language': 'Select Language:',
                'select_theme': 'Select Theme:',
                'dark_theme': 'Dark',
                'light_theme': 'Light',
                'italian': 'Italian',
                'english': 'English',
                'search_placeholder': 'Search by keywords...',
                'all_categories': 'All Categories',
                'enter_tags': 'Enter tags...',
                'search_button': 'üîç Search',
                'restore_backup': 'Restore Backup',
                'export_data': 'Export Data',
                'import_data': 'Import Data',
                'new_category': 'New category',
                'add_category': 'Add Category',
                'show_favorites': 'Show Favorites',
                'hide_favorites': 'Hide Favorites',
                'new_prompt': 'New Prompt',
                'title_label': 'Title',
                'tags_label': 'Tags (comma-separated)',
                'tags_placeholder': 'Enter tags separated by commas...',
                'text_label': 'Text',
                'add_button': 'Add',
                'modify_button': 'Edit',
                'save_button': 'Save',
                'delete_button': 'Delete',
                'copy_button': 'Copy',
                'increase_font_button': 'Increase Font',
                'share_button': 'Share',
                'favorite_button': '‚òÖ Favorite',
                'not_favorite_button': '‚òÜ Favorite',
                'remove_favorite_button': 'Remove from Favorites',
                'search_results': 'Search Results',
                'no_results_found': 'No results found.',
                'favorites_title': 'Favorite Prompts',
                'no_favorites_found': 'No favorite prompts found.',
                'confirm_delete_prompt': 'Are you sure you want to delete this prompt?',
                'confirm_delete_category': 'Are you sure you want to delete this category?',
                'confirm_restore_backup': 'Are you sure you want to restore the backup? All recent changes will be lost.',
                'backup_restored': 'Backup restored successfully.',
                'no_backup_available': 'No backup available.',
                'data_imported': 'Data imported successfully.',
                'invalid_file_format': 'Invalid file format.',
                'import_error': 'Error importing data: ',
                'prompt_copied': 'Prompt copied to clipboard!',
                'prompt_shared': 'Prompt shared successfully!',
                'share_error': 'Error sharing the prompt: ',
                'copy_error': 'Error copying the text: ',
                'copy_count_label': 'Copied: ',
                'edit_count_label': 'Edited: ',
                'modify_color': 'Modify Color:',
                'feedback_button': 'Feedback',
                'feedback_title': 'Feedback',
                'feedback_label': 'Your feedback:',
                'send_feedback_button': 'Send Feedback',
                'feedback_thanks': 'Thank you for your feedback!',
            },
            // Aggiungi altre lingue qui
        };

        function translateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = translations[currentLanguage][key] || key;
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[currentLanguage][key] || key;
            });

            // Aggiorna il titolo della pagina
            document.title = translations[currentLanguage]['title'];
        }

        function loadFromLocalStorage() {
            var savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
                // Imposta i valori di default per copyCount, editCount e color se non esistono
                categories.forEach(category => {
                    if (!category.color) category.color = '#6c757d'; // Colore di default grigio
                    category.prompts.forEach(prompt => {
                        if (prompt.copyCount === undefined) prompt.copyCount = 0;
                        if (prompt.editCount === undefined) prompt.editCount = 0;
                    });
                });
                saveToLocalStorage(); // Salva le categorie aggiornate con i colori di default
                renderCategories();
                populateCategoryFilter();
            }

            var savedFeedbacks = localStorage.getItem('feedbacks');
            if (savedFeedbacks) {
                feedbacks = JSON.parse(savedFeedbacks);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
        }

        function backupData() {
            localStorage.setItem('categories_backup', JSON.stringify(categories));
        }

        function renderCategories() {
            var container = document.getElementById('categories');
            var categoryBoxesContainer = document.getElementById('category-boxes-container');
            container.innerHTML = '';
            categoryBoxesContainer.innerHTML = '';

            // Non ordiniamo le categorie per nome per mantenere l'ordine personalizzato

            categories.forEach((category, index) => {
                const categoryDiv = document.createElement('button');
                categoryDiv.className = 'category-btn';

                // Assicuriamoci che category.color abbia un valore di default
                const categoryColor = category.color || '#6c757d'; // Default grigio
                const textColor = getContrastYIQ(categoryColor);
                categoryDiv.style.backgroundColor = categoryColor;
                categoryDiv.style.color = textColor;

                // Aggiungi indicatore di colore
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                colorIndicator.style.backgroundColor = categoryColor;
                categoryDiv.appendChild(colorIndicator);

                const categoryNameSpan = document.createElement('span');
                categoryNameSpan.textContent = category.name;
                categoryDiv.appendChild(categoryNameSpan);

                categoryDiv.onclick = () => {
                    toggleCategoryBox(categoryDiv, index);
                };

                container.appendChild(categoryDiv);

                const categoryBox = createCategoryBox(category, index);
                categoryBoxesContainer.appendChild(categoryBox);
            });

            // Inizializza SortableJS per il drag-and-drop delle categorie
            Sortable.create(container, {
                animation: 150,
                onEnd: function (evt) {
                    const movedCategory = categories.splice(evt.oldIndex, 1)[0];
                    categories.splice(evt.newIndex, 0, movedCategory);
                    saveToLocalStorage();
                }
            });
        }

        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = `<option value="">${translations[currentLanguage]['all_categories']}</option>`;
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }

        function searchPrompts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedCategory = document.getElementById('categoryFilter').value;
            const selectedDate = document.getElementById('dateFilter').value;
            const selectedTag = document.getElementById('tagFilter').value.toLowerCase().trim();

            const promptsDisplayContainer = document.getElementById('prompts-display-container');
            promptsDisplayContainer.innerHTML = `<h2>${translations[currentLanguage]['search_results']}</h2>`;

            let resultsFound = false;

            categories.forEach((category, categoryIndex) => {
                if (selectedCategory && category.name !== selectedCategory) return;

                const filteredPrompts = category.prompts.filter(prompt => {
                    const matchTitleOrText = prompt.title.toLowerCase().includes(searchQuery) || prompt.text.toLowerCase().includes(searchQuery);
                    const matchDate = !selectedDate || prompt.date === selectedDate;
                    const matchTag = !selectedTag || (prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(selectedTag)));

                    return matchTitleOrText && matchDate && matchTag;
                });

                if (filteredPrompts.length > 0) {
                    resultsFound = true;

                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category.name;
                    promptsDisplayContainer.appendChild(categoryHeader);

                    const promptGrid = document.createElement('div');
                    promptGrid.className = 'prompt-grid';

                    filteredPrompts.forEach((prompt, promptIndex) => {
                        const { promptDiv } = createPromptDiv(prompt, categoryIndex, promptIndex);
                        promptGrid.appendChild(promptDiv);
                    });

                    promptsDisplayContainer.appendChild(promptGrid);
                }
            });

            if (!resultsFound) {
                promptsDisplayContainer.innerHTML += `<p>${translations[currentLanguage]['no_results_found']}</p>`;
            }
        }

        function createCategoryBox(category, categoryIndex) {
            const categoryBox = document.createElement('div');
            categoryBox.className = 'category-box';
            categoryBox.style.display = (categoryIndex === activeCategoryIndex) ? 'block' : 'none';

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header d-flex align-items-center';

            const categoryInput = document.createElement('input');
            categoryInput.type = 'text';
            categoryInput.value = category.name;
            categoryInput.className = 'form-control mr-2';
            categoryInput.readOnly = true;
            categoryHeader.appendChild(categoryInput);

            const colorLabel = document.createElement('label');
            colorLabel.textContent = translations[currentLanguage]['modify_color'];
            colorLabel.className = 'mr-2 ml-2';
            categoryHeader.appendChild(colorLabel);

            const colorInput = document.createElement('input');
            colorInput.type = 'color';
            colorInput.value = category.color || '#6c757d';
            colorInput.disabled = true;
            colorInput.className = 'form-control';
            colorInput.style.maxWidth = '50px';
            colorInput.style.padding = '0';
            categoryHeader.appendChild(colorInput);

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-info btn-edit btn-custom';
            editBtn.textContent = translations[currentLanguage]['modify_button'];
            categoryHeader.appendChild(editBtn);

            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-save btn-custom';
            saveBtn.textContent = translations[currentLanguage]['save_button'];
            categoryHeader.appendChild(saveBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-delete btn-custom';
            deleteBtn.textContent = translations[currentLanguage]['delete_button'];
            categoryHeader.appendChild(deleteBtn);

            categoryBox.appendChild(categoryHeader);

            editBtn.onclick = () => {
                categoryInput.readOnly = false;
                colorInput.disabled = false;
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline';
            };

            saveBtn.onclick = () => {
                categoryInput.readOnly = true;
                colorInput.disabled = true;
                editBtn.style.display = 'inline';
                saveBtn.style.display = 'none';
                categories[categoryIndex].name = categoryInput.value;
                categories[categoryIndex].color = colorInput.value;
                saveToLocalStorage();
                renderCategories();
            };

            deleteBtn.onclick = () => {
                deleteCategory(categoryIndex);
            };

            const promptTitlesContainer = document.createElement('div');
            promptTitlesContainer.className = 'prompt-titles-container d-flex flex-wrap';

            const selectedPromptContainer = document.createElement('div');
            selectedPromptContainer.className = 'selected-prompt-container';

            category.prompts.sort((a, b) => a.title.localeCompare(b.title));

            category.prompts.forEach((prompt, promptIndex) => {
                const promptTitleDiv = createPromptTitleDiv(prompt, categoryIndex, promptIndex, selectedPromptContainer);
                promptTitlesContainer.appendChild(promptTitleDiv);

                // Se √® il prompt attivo, visualizzalo aperto
                if (categoryIndex === activeCategoryIndex && promptIndex === activePromptIndex) {
                    displaySelectedPrompt(prompt, categoryIndex, promptIndex, selectedPromptContainer);
                }
            });

            categoryBox.appendChild(promptTitlesContainer);
            categoryBox.appendChild(selectedPromptContainer);

            const newPromptBtn = document.createElement('button');
            newPromptBtn.className = 'btn btn-success btn-new mt-3';
            newPromptBtn.textContent = translations[currentLanguage]['new_prompt'];
            newPromptBtn.onclick = () => {
                showNewPromptForm(categoryIndex);
            };
            categoryBox.appendChild(newPromptBtn);

            return categoryBox;
        }

        function createPromptTitleDiv(prompt, categoryIndex, promptIndex, selectedPromptContainer) {
            const promptTitleDiv = document.createElement('button');
            promptTitleDiv.className = 'btn btn-secondary mr-2 mb-2';
            promptTitleDiv.textContent = prompt.title;

            promptTitleDiv.onclick = () => {
                activeCategoryIndex = categoryIndex;
                activePromptIndex = promptIndex;
                displaySelectedPrompt(prompt, categoryIndex, promptIndex, selectedPromptContainer);
            };

            return promptTitleDiv;
        }

        function createPromptDiv(prompt, categoryIndex, promptIndex) {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'prompt-content';

            const title = document.createElement('h4');
            title.textContent = prompt.title;
            promptDiv.appendChild(title);

            const tagsDiv = document.createElement('div');
            if (prompt.tags) {
                prompt.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag-badge';
                    tagSpan.textContent = tag;
                    tagsDiv.appendChild(tagSpan);
                });
            }
            promptDiv.appendChild(tagsDiv);

            const content = document.createElement('div');
            // Rimuove gli stili di colore dal testo
            content.innerHTML = removeColorStylesFromHTML(prompt.text);
            promptDiv.appendChild(content);

            // Sezione per le statistiche
            const statsDiv = document.createElement('div');
            statsDiv.className = 'prompt-stats mt-2';

            const copyCountSpan = document.createElement('span');
            copyCountSpan.textContent = `${translations[currentLanguage]['copy_count_label']}${prompt.copyCount || 0}`;
            statsDiv.appendChild(copyCountSpan);

            const separator = document.createElement('span');
            separator.textContent = ' | ';
            statsDiv.appendChild(separator);

            const editCountSpan = document.createElement('span');
            editCountSpan.textContent = `${translations[currentLanguage]['edit_count_label']}${prompt.editCount || 0}`;
            statsDiv.appendChild(editCountSpan);

            promptDiv.appendChild(statsDiv);

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'mt-3';

            // Ordine dei bottoni: Modifica, Copia, Elimina, Aumenta il font, Condividi, Preferito/Elimina dai Preferiti
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-info btn-edit btn-custom';
            editBtn.textContent = translations[currentLanguage]['modify_button'];
            buttonsDiv.appendChild(editBtn);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-copy btn-custom';
            copyBtn.textContent = translations[currentLanguage]['copy_button'];
            buttonsDiv.appendChild(copyBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-delete btn-custom';
            deleteBtn.textContent = translations[currentLanguage]['delete_button'];
            buttonsDiv.appendChild(deleteBtn);

            const fontBtn = document.createElement('button');
            fontBtn.className = 'btn btn-font btn-custom';
            fontBtn.textContent = translations[currentLanguage]['increase_font_button'];
            buttonsDiv.appendChild(fontBtn);

            const shareBtn = document.createElement('button');
            shareBtn.className = 'btn btn-share btn-custom';
            shareBtn.textContent = translations[currentLanguage]['share_button'];
            buttonsDiv.appendChild(shareBtn);

            // Bottone per aggiungere/rimuovere dai preferiti
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = 'btn btn-favorite btn-custom';
            favoriteBtn.textContent = prompt.favorite ? translations[currentLanguage]['favorite_button'] : translations[currentLanguage]['not_favorite_button'];
            buttonsDiv.appendChild(favoriteBtn);

            // Se il prompt √® nei preferiti, aggiungi il bottone "Elimina dai Preferiti"
            if (prompt.favorite) {
                const removeFavoriteBtn = document.createElement('button');
                removeFavoriteBtn.className = 'btn btn-remove-favorite btn-custom';
                removeFavoriteBtn.textContent = translations[currentLanguage]['remove_favorite_button'];
                buttonsDiv.appendChild(removeFavoriteBtn);

                removeFavoriteBtn.onclick = () => {
                    prompt.favorite = false;
                    saveToLocalStorage();
                    renderCategories();
                    if (document.getElementById('prompts-display-container').innerHTML.includes(translations[currentLanguage]['favorites_title'])) {
                        showFavoritePrompts();
                    }
                };
            }

            promptDiv.appendChild(buttonsDiv);

            copyBtn.onclick = () => {
                var plainText = htmlToPlainText(prompt.text);
                navigator.clipboard.writeText(plainText).then(() => {
                    prompt.copyCount = (prompt.copyCount || 0) + 1;
                    saveToLocalStorage();
                    copyCountSpan.textContent = `${translations[currentLanguage]['copy_count_label']}${prompt.copyCount}`;
                    alert(translations[currentLanguage]['prompt_copied']);
                }).catch(err => {
                    console.error(translations[currentLanguage]['copy_error'], err);
                });
            };

            fontBtn.onclick = () => {
                content.style.fontSize = 'larger';
            };

            editBtn.onclick = () => {
                showEditPromptForm(prompt, categoryIndex, promptIndex);
            };

            deleteBtn.onclick = () => {
                if (confirm(translations[currentLanguage]['confirm_delete_prompt'])) {
                    backupData();
                    categories[categoryIndex].prompts.splice(promptIndex, 1);
                    saveToLocalStorage();
                    renderCategories();
                    if (document.getElementById('prompts-display-container').innerHTML.includes(translations[currentLanguage]['favorites_title'])) {
                        showFavoritePrompts();
                    }
                }
            };

            shareBtn.onclick = () => {
                sharePrompt(prompt);
            };

            favoriteBtn.onclick = () => {
                prompt.favorite = !prompt.favorite;
                saveToLocalStorage();
                favoriteBtn.textContent = prompt.favorite ? translations[currentLanguage]['favorite_button'] : translations[currentLanguage]['not_favorite_button'];
                renderCategories();
                if (document.getElementById('prompts-display-container').innerHTML.includes(translations[currentLanguage]['favorites_title'])) {
                    showFavoritePrompts();
                }
            };

            return { promptDiv };
        }

        // Funzione per rimuovere gli stili di colore dal testo HTML
        function removeColorStylesFromHTML(html) {
            var div = document.createElement('div');
            div.innerHTML = html;

            var elements = div.getElementsByTagName('*');
            for (var i = 0; i < elements.length; i++) {
                elements[i].style.color = '';
            }

            return div.innerHTML;
        }

        function htmlToPlainText(html) {
            var tempElement = document.createElement('div');
            tempElement.innerHTML = html;

            // Rimuovi script e stili
            var scripts = tempElement.getElementsByTagName('script');
            for (var i = scripts.length - 1; i >= 0; i--) {
                scripts[i].parentNode.removeChild(scripts[i]);
            }
            var styles = tempElement.getElementsByTagName('style');
            for (var i = styles.length - 1; i >= 0; i--) {
                styles[i].parentNode.removeChild(styles[i]);
            }

            // Gestisci <br> come newline
            tempElement.innerHTML = tempElement.innerHTML.replace(/<br\s*[\/]?>/gi, '\n');

            // Gestisci elenchi ordinati
            var olElements = tempElement.getElementsByTagName('ol');
            for (var i = 0; i < olElements.length; i++) {
                var ol = olElements[i];
                var items = ol.getElementsByTagName('li');
                for (var j = 0; j < items.length; j++) {
                    items[j].innerText = (j + 1) + '. ' + items[j].innerText;
                }
                ol.outerHTML = ol.innerHTML;
            }

            // Gestisci elenchi non ordinati
            var ulElements = tempElement.getElementsByTagName('ul');
            for (var i = 0; i < ulElements.length; i++) {
                var ul = ulElements[i];
                var items = ul.getElementsByTagName('li');
                for (var j = 0; j < items.length; j++) {
                    items[j].innerText = '- ' + items[j].innerText;
                }
                ul.outerHTML = ul.innerHTML;
            }

            // Ottieni il testo
            var text = tempElement.textContent || tempElement.innerText || '';

            // Rimuovi spazi e newline multipli
            text = text.replace(/\n\s*\n/g, '\n').trim();

            return text;
        }

        function displaySelectedPrompt(prompt, categoryIndex, promptIndex, container) {
            container.innerHTML = '';
            const { promptDiv } = createPromptDiv(prompt, categoryIndex, promptIndex);
            container.appendChild(promptDiv);
        }

        function toggleCategoryBox(categoryDiv, categoryIndex) {
            const categoryBoxes = document.querySelectorAll('.category-box');
            const categoryDivs = document.querySelectorAll('#categories .category-btn');
            categoryBoxes.forEach((box, idx) => {
                if (idx === categoryIndex) {
                    const isVisible = box.style.display === 'block';
                    box.style.display = isVisible ? 'none' : 'block';
                    if (isVisible) {
                        categoryDiv.style.border = 'none';
                    } else {
                        categoryDiv.style.border = '2px solid #28a745';
                    }
                } else {
                    box.style.display = 'none';
                    categoryDivs[idx].style.border = 'none';
                }
            });
        }

        function showNewPromptForm(categoryIndex) {
            $('#newPromptModal').modal('show');
            $('#newPromptModalLabel').text(translations[currentLanguage]['new_prompt']);

            $('#newPromptForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const title = $('#promptTitle').val();
                const text = quill.root.innerHTML;
                const tags = $('#promptTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

                if (title && text) {
                    categories[categoryIndex].prompts.push({
                        title,
                        text,
                        tags,
                        favorite: false,
                        copyCount: 0,
                        editCount: 0
                    });
                    saveToLocalStorage();

                    // Imposta gli indici attivi per visualizzare il nuovo prompt
                    activeCategoryIndex = categoryIndex;
                    activePromptIndex = categories[categoryIndex].prompts.length - 1;

                    renderCategories();
                    $('#newPromptModal').modal('hide');
                    $('#newPromptForm')[0].reset();
                    quill.setText('');
                }
            });
        }

        function showEditPromptForm(prompt, categoryIndex, promptIndex) {
            $('#newPromptModal').modal('show');
            $('#newPromptModalLabel').text(translations[currentLanguage]['modify_button']);
            $('#promptTitle').val(prompt.title);
            $('#promptTags').val(prompt.tags ? prompt.tags.join(', ') : '');
            quill.root.innerHTML = prompt.text;

            $('#newPromptForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const title = $('#promptTitle').val();
                const text = quill.root.innerHTML;
                const tags = $('#promptTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

                if (title && text) {
                    prompt.title = title;
                    prompt.text = text;
                    prompt.tags = tags;
                    prompt.editCount = (prompt.editCount || 0) + 1;
                    saveToLocalStorage();

                    // Imposta gli indici attivi per visualizzare il prompt modificato
                    activeCategoryIndex = categoryIndex;
                    activePromptIndex = promptIndex;
                    $('#newPromptModal').modal('hide');
                    renderCategories();
                }
            });
        }

        function deleteCategory(categoryIndex) {
            if (confirm(translations[currentLanguage]['confirm_delete_category'])) {
                backupData();
                categories.splice(categoryIndex, 1);
                saveToLocalStorage();
                renderCategories();
            }
        }

        function sharePrompt(prompt) {
            var plainText = htmlToPlainText(prompt.text);
            var shareData = {
                title: prompt.title,
                text: plainText,
            };

            if (navigator.share) {
                navigator.share(shareData).then(() => {
                    console.log(translations[currentLanguage]['prompt_shared']);
                }).catch(err => {
                    console.error(translations[currentLanguage]['share_error'], err);
                });
            } else {
                // Se l'API Web Share non √® supportata, copia il testo negli appunti
                navigator.clipboard.writeText(plainText).then(() => {
                    alert(translations[currentLanguage]['prompt_copied']);
                }).catch(err => {
                    console.error(translations[currentLanguage]['copy_error'], err);
                });
            }
        }

        function showFavoritePrompts() {
            const promptsDisplayContainer = document.getElementById('prompts-display-container');
            promptsDisplayContainer.innerHTML = `<h2>${translations[currentLanguage]['favorites_title']}</h2>`;
            document.getElementById('hideFavoritesBtn').style.display = 'inline-block';
            document.getElementById('showFavoritesBtn').style.display = 'none';
            let resultsFound = false;

            categories.forEach((category, categoryIndex) => {
                const favoritePrompts = category.prompts.reduce((accumulator, prompt, index) => {
                    if (prompt.favorite) {
                        accumulator.push({ prompt, index });
                    }
                    return accumulator;
                }, []);

                if (favoritePrompts.length > 0) {
                    resultsFound = true;

                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = category.name;
                    promptsDisplayContainer.appendChild(categoryHeader);

                    const promptGrid = document.createElement('div');
                    promptGrid.className = 'prompt-grid';

                    favoritePrompts.forEach(({ prompt, index }) => {
                        const { promptDiv } = createPromptDiv(prompt, categoryIndex, index);
                        promptGrid.appendChild(promptDiv);
                    });

                    promptsDisplayContainer.appendChild(promptGrid);
                }
            });

            if (!resultsFound) {
                promptsDisplayContainer.innerHTML += `<p>${translations[currentLanguage]['no_favorites_found']}</p>`;
            }
        }

        function hideFavoritePrompts() {
            const promptsDisplayContainer = document.getElementById('prompts-display-container');
            promptsDisplayContainer.innerHTML = '';
            document.getElementById('hideFavoritesBtn').style.display = 'none';
            document.getElementById('showFavoritesBtn').style.display = 'inline-block';
        }

        document.getElementById('addCategoryBtn').onclick = function () {
            const categoryName = document.getElementById('newCategoryInput').value;
            const categoryColor = document.getElementById('newCategoryColor').value || '#6c757d';
            if (categoryName) {
                categories.push({ name: categoryName, prompts: [], color: categoryColor });
                saveToLocalStorage();
                renderCategories();
                document.getElementById('newCategoryInput').value = '';
                document.getElementById('newCategoryColor').value = '#6c757d';
            }
        };

        document.getElementById('searchBtn').onclick = searchPrompts;

        document.getElementById('searchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                searchPrompts();
            }
        });

        document.getElementById('restoreBackupBtn').onclick = function () {
            if (confirm(translations[currentLanguage]['confirm_restore_backup'])) {
                var backup = localStorage.getItem('categories_backup');
                if (backup) {
                    categories = JSON.parse(backup);
                    // Imposta i valori di default per copyCount, editCount e color se non esistono
                    categories.forEach(category => {
                        if (!category.color) category.color = '#6c757d'; // Colore di default grigio
                        category.prompts.forEach(prompt => {
                            if (prompt.copyCount === undefined) prompt.copyCount = 0;
                            if (prompt.editCount === undefined) prompt.editCount = 0;
                        });
                    });
                    saveToLocalStorage();
                    renderCategories();
                    alert(translations[currentLanguage]['backup_restored']);
                } else {
                    alert(translations[currentLanguage]['no_backup_available']);
                }
            }
        };

        document.getElementById('exportDataBtn').onclick = function () {
            var dataStr = JSON.stringify(categories);
            var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            var exportFileDefaultName = 'prompts_backup_' + new Date().toISOString().slice(0, 19) + '.json';

            var linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        document.getElementById('importDataBtn').onclick = function () {
            var fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';

            fileInput.onchange = function (event) {
                var file = event.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            var importedData = JSON.parse(e.target.result);
                            if (Array.isArray(importedData)) {
                                categories = importedData;
                                // Imposta i valori di default per copyCount, editCount e color se non esistono
                                categories.forEach(category => {
                                    if (!category.color) category.color = '#6c757d'; // Colore di default grigio
                                    category.prompts.forEach(prompt => {
                                        if (prompt.copyCount === undefined) prompt.copyCount = 0;
                                        if (prompt.editCount === undefined) prompt.editCount = 0;
                                    });
                                });
                                saveToLocalStorage();
                                renderCategories();
                                alert(translations[currentLanguage]['data_imported']);
                            } else {
                                alert(translations[currentLanguage]['invalid_file_format']);
                            }
                        } catch (err) {
                            alert(translations[currentLanguage]['import_error'] + err);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            fileInput.click();
        };

        document.getElementById('showFavoritesBtn').onclick = showFavoritePrompts;
        document.getElementById('hideFavoritesBtn').onclick = hideFavoritePrompts;

        document.getElementById('languageSelect').onchange = function () {
            currentLanguage = this.value;
            translateUI();
            renderCategories();
            populateCategoryFilter();

            // Aggiorna il placeholder dell'editor Quill
            quill.root.dataset.placeholder = translations[currentLanguage]['text_label'];
        };

        // Gestione del tema
        document.getElementById('themeSelect').onchange = function () {
            currentTheme = this.value;
            applyTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        };

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }

            // Aggiorna i colori dell'editor Quill
            updateQuillTheme();
        }

        function updateQuillTheme() {
            var qlEditor = document.querySelector('.ql-editor');
            var qlToolbar = document.querySelector('.ql-toolbar');

            qlEditor.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--ql-editor-background-color').trim();
            qlEditor.style.color = getComputedStyle(document.documentElement).getPropertyValue('--ql-editor-text-color').trim();

            qlToolbar.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--ql-toolbar-background-color').trim();
            qlToolbar.querySelectorAll('.ql-stroke').forEach(icon => {
                icon.style.stroke = getComputedStyle(document.documentElement).getPropertyValue('--ql-toolbar-icon-color').trim();
            });
            qlToolbar.querySelectorAll('.ql-fill').forEach(icon => {
                icon.style.fill = getComputedStyle(document.documentElement).getPropertyValue('--ql-toolbar-icon-color').trim();
            });
        }

        // Funzione per determinare il colore del testo in base al colore di sfondo
        function getContrastYIQ(hexcolor) {
            hexcolor = hexcolor || '#6c757d'; // Colore di default grigio
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0, 2), 16);
            var g = parseInt(hexcolor.substr(2, 2), 16);
            var b = parseInt(hexcolor.substr(4, 2), 16);
            var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000' : '#fff';
        }

        // Gestione del feedback
        document.getElementById('feedbackBtn').onclick = function () {
            $('#feedbackModal').modal('show');
            $('#feedbackModalLabel').text(translations[currentLanguage]['feedback_title']);
        };

        $('#feedbackForm').on('submit', function (e) {
            e.preventDefault();
            const feedbackText = $('#feedbackText').val().trim();
            if (feedbackText) {
                feedbacks.push({
                    text: feedbackText,
                    date: new Date().toISOString()
                });
                saveToLocalStorage();
                $('#feedbackModal').modal('hide');
                $('#feedbackForm')[0].reset();
                alert(translations[currentLanguage]['feedback_thanks']);
            }
        });

        // Inizializza Quill
        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: translations[currentLanguage]['text_label'],
            modules: {
                toolbar: [
                    [{ header: [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    ['link', 'blockquote', 'code-block'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['clean']
                ]
            }
        });

        // Imposta la lingua corrente in base al selettore di lingua
        currentLanguage = document.getElementById('languageSelect').value;

        // Imposta il tema corrente in base al selettore di tema
        currentTheme = localStorage.getItem('theme') || 'dark';
        document.getElementById('themeSelect').value = currentTheme;
        applyTheme(currentTheme);

        // Inizializzazione
        translateUI();
        loadFromLocalStorage();
        populateCategoryFilter();

    </script>
</body>

</html>
